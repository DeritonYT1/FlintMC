import org.apache.commons.io.FileUtils
import org.apache.tools.ant.taskdefs.condition.Os

plugins {
    id 'application'
    id 'java-library'
}

group 'net.labyfy.versioned'

sourceCompatibility = 1.8

labyfy {
    version "1.15.2"
    provideMappings true
    publishToken "${labyfy_publish_token}"
    publishUrl "${labyfy_publish_url}"
}

repositories {
    mavenCentral()
}

dependencies {
    api 'net.minecraft:client:1.15.2'
    api 'net.minecraft:server:1.15.2'

    api project(':component:launcher')

    runtimeOnly project(path: ':component:stereotype', configuration: 'internal')
    runtimeOnly project(':component:stereotype')
    runtimeOnly project(':component:transform:javassist')
    runtimeOnly project(path: ':component:transform:javassist', configuration: 'internal')
    runtimeOnly project(':component:transform:asm')
    runtimeOnly project(path: ':component:transform:asm', configuration: 'internal')
    runtimeOnly project(':component:transform:minecraft')
    runtimeOnly project(':component:transform:minecraft-obfuscator')
    runtimeOnly project(':component:transform:hook')
    runtimeOnly project(path: ':component:transform:hook', configuration: 'internal')
    runtimeOnly project(path: ':component:gui', configuration: 'internal')
    runtimeOnly project(path: ':component:gui:juklearmc', configuration: 'internal')
    runtimeOnly project(':component:gui:juklearmc:juklearmc-1.15.2')
    runtimeOnly project(':component:gui:gui-1.15.2')
    runtimeOnly project(path: ':component:tasks', configuration: 'internal')
    runtimeOnly project(':component:tasks:tasks-1.15.2')
    runtimeOnly project(':component:mapping')
    runtimeOnly project(path: ':component:inject', configuration: 'internal')
    runtimeOnly project(':component:transform:hook')
    runtimeOnly project(':component:resources')
    runtimeOnly project(':component:resources:resources-1.15.2')
    runtimeOnly project(':versioned:labyfy-1.15.2')
    runtimeOnly project(path: ':component:packages', configuration: 'internal')
    runtimeOnly project(path: ':component:security', configuration: 'internal')

    labyManifest project(':component:stereotype')
    labyManifest project(':component:transform:javassist')
    labyManifest project(':component:transform:asm')
    labyManifest project(':component:transform:minecraft')
    labyManifest project(':component:transform:minecraft-obfuscator')
    labyManifest project(':component:transform:hook')
    labyManifest project(':component:gui')
    labyManifest project(':component:gui')
    labyManifest project(':component:gui:juklearmc')
    labyManifest project(':component:gui:juklearmc:juklearmc-1.15.2')
    labyManifest project(':component:gui:gui-1.15.2')
    labyManifest project(':component:tasks')
    labyManifest project(':component:tasks:tasks-1.15.2')
    labyManifest project(':component:mapping')
    labyManifest project(':component:inject')
    labyManifest project(':component:transform:hook')
    labyManifest project(':component:resources')
    labyManifest project(':component:resources:resources-1.15.2')
    labyManifest project(':component:packages')
    labyManifest project(':component:transform:launcher-plugin')
    labyManifest project(':component:launcher')
    labyManifest project(':component:service')
    labyManifest project(':component:security')
}

application {
    mainClassName "net.labyfy.component.launcher.LabyLauncher"
}

distTar.enabled = false
distZip.enabled = false
installDist.enabled = false
startScripts.enabled = false

def runDir = new File(rootProject.projectDir, "run/1.15.2")
def runDirTemplate = new File(rootProject.projectDir, "run-template")
if (!runDir.exists()) {
    if (!runDir.mkdirs()) {
        throw new GradleException("Failed to create run directory: ${runDir.absolutePath}")
    } else {
        copy {
            from new File(runDirTemplate, "1.15.2")
            into runDir
        }
    }
}

run {
    workingDir runDir
    args "--uuid", "113da2d6-3c68-43c4-bee0-6f53fe8906e6",
            "--username", "DevTastisch",
            "--accessToken", "0",
            "--version", "1.15.2",
            "--assetsDir", "assets",
            "--assetIndex", "1.15",
            "--userProperties", "{}",
            "--gameDir", ".",
            "--tweakClass", "net.labyfy.component.transform.tweaker.LabyDebugTweaker",
            "--sentry", "false"
    dependsOn 'copyMappings'

    if(Os.isFamily(Os.FAMILY_MAC)) {
        jvmArgs '-XstartOnFirstThread'
    }
}

task copyMappings() {
    doLast {
        def extracted = new File(project.buildDir, "labyfy/mappings/1.15.2/extracted")
        FileUtils.copyFile(new File(extracted, "fields.csv"), new File(project.parent.parent.projectDir, "run/1.15.2/Labyfy/assets/1.15.2/fields.csv"))
        FileUtils.copyFile(new File(extracted, "methods.csv"), new File(project.parent.parent.projectDir, "run/1.15.2/Labyfy/assets/1.15.2/methods.csv"))
        FileUtils.copyFile(new File(extracted, "params.csv"), new File(project.parent.parent.projectDir, "run/1.15.2/Labyfy/assets/1.15.2/params.csv"))
        FileUtils.copyFile(new File(extracted, "joined.tsrg"), new File(project.parent.parent.projectDir, "run/1.15.2/Labyfy/assets/1.15.2/joined.tsrg"))
    }
}
